<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: analytics/MediaStatistic.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: analytics/MediaStatistic.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as Events from '../utils/Events.js';
import SRGStreamType from '../utils/SRGStreamType.js';

/**
 * @ignore
 */
class MediaStatistic {
  constructor(player, hostName = 'il.srgssr.ch', debug = false) {
    this.debug = debug;
    this.player = player;
    this.baseUrl = `${hostName}/integrationlayer/2.0/`;

    this.player.on(Events.SOCIAL_SHARING, this.socialSharing.bind(this));
    this.player.on(Events.FIRST_PLAY, this.clicked.bind(this));
  }

  /**
   * Build mediaStatistic URL
   *
   * @param {Object} media
   * @param {String} media.service
   * @param {String} media.bu
   * @param {String} media.id
   * @param {String} media.mediaType
   *
   * @returns {String}
   */
  buildUrl({
    service, bu, id, mediaType,
  }) {
    return `https://${this.baseUrl}${bu.toLowerCase()}/mediaStatistic/${mediaType.toLowerCase()}/${id}/${service}.json`;
  }

  /**
   * At the first play sends a clicked media after a certain threshold
   */
  clicked() {
    this.player.one(Events.PLAYING, () => {
      const { userId } = MediaStatistic;
      const {
        streamType,
        eventData,
        ...loadedMedia
      } = this.loadedMedia();
      const buildUrl = this.buildUrl({
        service: 'clicked',
        ...loadedMedia,
      });
      const payload = { eventData };
      const timeoutTreshold = this.timeoutTreshold(streamType);

      if (userId) {
        payload.userId = userId;
      }

      if (eventData) {
        setTimeout(() => {
          this.send(buildUrl, payload);
        }, timeoutTreshold);
      }
    });
  }

  /**
   * Get the loaded media independently if it comes from the pending segment or the main chapter.
   *
   * @returns {Object} media
   * @returns {String} media.bu
   * @returns {String} media.id
   * @returns {String} media.eventData
   * @returns {String} media.mediaType
   * @returns {String} media.streamType
   */
  loadedMedia() {
    const {
      bu,
      id,
      eventData,
      mediaType,
      streamType,
      pendingSegment: {
        vendor,
        eventData: segmentEventData,
        id: segmentId,
        mediaType: SegmentMediaType,
        streamType: segmentStreamType,
      } = {},
    } = this.player.currentSource();

    return {
      bu: vendor || bu,
      eventData: segmentEventData || eventData,
      id: segmentId || id,
      mediaType: SegmentMediaType || mediaType,
      streamType: segmentStreamType || streamType,
    };
  }

  /**
   * Custom logger
   *
   * @param {String} subject
   * @param  {...any} data
   */
  log(subject, ...data) {
    if (this.debug) {
      console.log( // eslint-disable-line no-console
        `MediaStatistic:${subject}`, ...data,
      );
    }
  }

  /**
   * Send the request
   *
   * @param {String} url
   * @param {Object} payload
   */
  send(url, payload) {
    this.log('socialSharing', url, payload);

    fetch(url, {
      headers: {
        'Content-Type': 'application/json',
      },
      method: 'POST',
      body: JSON.stringify(payload),
    })
      .then((response) => {
        this.log('response', response);
      });
  }

  /**
   * Sent when a share button is clicked
   *
   * @param {Object}
   */
  socialSharing({ data }) {
    const { userId } = MediaStatistic;
    const {
      eventData,
      ...loadedMedia
    } = data;
    const buildUrl = this.buildUrl({
      service: `shared/${loadedMedia.socialVendor}`,
      ...loadedMedia,
    });
    const payload = { eventData };

    if (userId) {
      payload.userId = userId;
    }

    if (eventData) {
      this.send(buildUrl, payload);
    }
  }

  /**
   * Calculate the timemout treshold according to the stream type or the media duration.
   *
   * @param {String} streamType
   * @returns {Number} 10 if media is a live stream or has a duration greater than 10, 0 otherwise.
   */
  timeoutTreshold(streamType) {
    const duration = this.player.duration();
    const hasDuration = Number.isFinite(duration) &amp;&amp; duration > 0;
    const durationThreshold = hasDuration ? duration * 0.8 : 0;
    const isLiveStream = !SRGStreamType.isOnDemand(streamType);

    return (isLiveStream || durationThreshold > 10) ? 10000 : durationThreshold;
  }

  /**
   * Get userId property if available
   */
  static get userId() {
    try {
      const item = JSON.parse(window.localStorage.getItem('playSRG-playUserIdv2'));

      if (item) {
        const { userId } = item;

        return userId;
      }
    } catch (error) {
      return undefined;
    }

    return undefined;
  }
}

export default MediaStatistic;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="SRGLetterbox.html">SRGLetterbox</a></li><li><a href="SRGLetterbox.MediaComposition.html">MediaComposition</a></li><li><a href="SRGUserStorage.html">SRGUserStorage</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:ADD_TRACK">ADD_TRACK</a></li><li><a href="global.html#event:ANIMATION_END">ANIMATION_END</a></li><li><a href="global.html#event:BEFOREUNLOAD">BEFOREUNLOAD</a></li><li><a href="global.html#event:CHANGE">CHANGE</a></li><li><a href="global.html#event:CLICK">CLICK</a></li><li><a href="global.html#event:KEY_DOWN">KEY_DOWN</a></li><li><a href="global.html#event:MOUSE_ENTER">MOUSE_ENTER</a></li><li><a href="global.html#event:srgssr/recommendationDisplayed">srgssr/recommendationDisplayed</a></li><li><a href="global.html#event:srgssr/recommendationHit">srgssr/recommendationHit</a></li><li><a href="global.html#event:WEBKIT_CURRENT_PLAYBACK_TARGET_IS_WIRELESS_CHANGED">WEBKIT_CURRENT_PLAYBACK_TARGET_IS_WIRELESS_CHANGED</a></li><li><a href="global.html#event:WEBKIT_PLAYBACK_TARGET_AVAILABILITY_CHANGED">WEBKIT_PLAYBACK_TARGET_AVAILABILITY_CHANGED</a></li><li><a href="SRGLetterbox.html#event:events">events</a></li><li><a href="SRGLetterbox.html#event:playerEvents">playerEvents</a></li><li><a href="SRGLetterbox.html#event:srgEvents">srgEvents</a></li><li><a href="SRGLetterbox.html#event:videojsEvents">videojsEvents</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ABORT">ABORT</a></li><li><a href="global.html#ALMOST_STARTING">ALMOST_STARTING</a></li><li><a href="global.html#containQualities">containQualities</a></li><li><a href="global.html#DISPOSE">DISPOSE</a></li><li><a href="global.html#filterMainResourcesByQuality">filterMainResourcesByQuality</a></li><li><a href="global.html#findChapterByUrn">findChapterByUrn</a></li><li><a href="global.html#findDrmListByResource">findDrmListByResource</a></li><li><a href="global.html#findMainSegment">findMainSegment</a></li><li><a href="global.html#findResourceListByUrn">findResourceListByUrn</a></li><li><a href="global.html#getChapters">getChapters</a></li><li><a href="global.html#getFilteredExternalSubtitles">getFilteredExternalSubtitles</a></li><li><a href="global.html#getMainBlockReason">getMainBlockReason</a></li><li><a href="global.html#getMainChapter">getMainChapter</a></li><li><a href="global.html#getMainChapterImageUrl">getMainChapterImageUrl</a></li><li><a href="global.html#getMainResources">getMainResources</a></li><li><a href="global.html#getMainSegments">getMainSegments</a></li><li><a href="global.html#getMainValidFromDate">getMainValidFromDate</a></li><li><a href="global.html#getMergedAnalyticsData">getMergedAnalyticsData</a></li><li><a href="global.html#getMergedAnalyticsMetadata">getMergedAnalyticsMetadata</a></li><li><a href="global.html#getResourceList">getResourceList</a></li><li><a href="global.html#getSubdivisions">getSubdivisions</a></li><li><a href="global.html#isSourceHD">isSourceHD</a></li><li><a href="global.html#MAX_ITEMS">MAX_ITEMS</a></li><li><a href="global.html#MAX_ROWS">MAX_ROWS</a></li><li><a href="global.html#MIN_HEIGHT">MIN_HEIGHT</a></li><li><a href="global.html#MIN_WIDTH">MIN_WIDTH</a></li><li><a href="global.html#orderMainResourcesByQuality">orderMainResourcesByQuality</a></li><li><a href="global.html#orderMainResourcesByStreamType">orderMainResourcesByStreamType</a></li><li><a href="global.html#PERCENTAGE_MEDIA_CONSUMED">PERCENTAGE_MEDIA_CONSUMED</a></li><li><a href="global.html#PERIOD">PERIOD</a></li><li><a href="global.html#prefix">prefix</a></li><li><a href="global.html#SOON_VALID_PERIOD">SOON_VALID_PERIOD</a></li><li><a href="global.html#TOLERANCE">TOLERANCE</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Fri Feb 12 2021 09:53:42 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
