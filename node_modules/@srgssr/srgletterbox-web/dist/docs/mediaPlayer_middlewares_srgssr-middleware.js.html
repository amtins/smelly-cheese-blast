<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: mediaPlayer/middlewares/srgssr-middleware.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: mediaPlayer/middlewares/srgssr-middleware.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import videojs from 'video.js';
import AkamaiTokenService from '../../utils/AkamaiTokenService.js';
import Drm from '../../utils/Drm.js';
import Utils from '../../utils/Utils.js';
import SRGStreamType from '../../utils/SRGStreamType.js';
import SRGTokenType from '../../utils/SRGTokenType.js';
import PerformanceReport from '../../diagnostics/PerformanceReport.js';
import PerformanceService from '../../diagnostics/PerformanceService.js';
import BlockingReason from '../../utils/BlockingReason.js';
import ERRORTYPE from '../../errors/errors.js';
import { version as playerVersion } from '../../../package.json';
import MediaCompositionPeriodicListener from './mediacomposition-periodic-listener.js';
import MediaComposition from '../../dataProvider/model/MediaComposition.js';
import * as PlayerEvents from '../../utils/PlayerEvents.js';
import * as SRGEvents from '../../utils/SRGEvents.js';
import * as SRGQuality from '../../utils/SRGQuality.js';
import SupportedDevices from '../../utils/SupportedDevices.js';

/**
 * Base SRGSSR Middleware using a media composition. The media composition can be local
 * or fetched remotely.
 *
 * @param player player
 * @ignore
 */
const SrgssrMiddleware = (player) => {
  const { log } = player;

  // TODO implement local storage
  function addExternalSubtitles() {
    const subtitles = player
      .options().SRGProviders
      .mediaComposition
      .getFilteredExternalSubtitles(log);

    subtitles.forEach((subtitle) => {
      player.addRemoteTextTrack({
        kind: subtitle.type === 'SDH' ? 'captions' : 'subtitles',
        label: subtitle.language,
        language: subtitle.locale,
        src: subtitle.url,
      });
    });
  }

  /**
   * Clear and close the error modal before loading a new source.
   */
  function clearError() {
    if (player.error() !== null) {
      player.error(null);
    }
  }

  /**
   * Initialize the performance report.
   * @param {String} urn
   */
  function createPerformanceReport(urn) {
    const performanceService = new PerformanceService();
    const performanceReport = new PerformanceReport(urn, Utils.getEnvironment(), playerVersion);
    const drmReport = () => {
      if (Drm.hasDrm([player.currentSource()])) {
        performanceReport.setDrmResult();
      }
    };
    const mediaCompositionReport = () => {
      const { mediaComposition } = player
        .options()
        .SRGProviders;

      if (mediaComposition) {
        const {
          blockReason,
          playableAbroad,
        } = mediaComposition
          .getMainChapter();

        performanceReport.setIlMediaComposition({
          blockReason,
          playableAbroad,
          noPlayableResourceFound: player.currentSources().length === 0,
        });
      }
    };
    const tokenReport = () => {
      if (SRGTokenType.isProtected([player.currentSource()])) {
        performanceReport.setTokenResult(player.currentSource().tokenDiagnostic);
      }
    };

    let errorEvent;
    let isErrorReportSent = false;

    const canplaythroughEvent = () => {
      mediaCompositionReport();
      drmReport();
      tokenReport();

      performanceReport.setPlayerResult({
        url: player.currentSource().src,
        duration: false,
      });
      performanceService.send(performanceReport);

      player.off(PlayerEvents.ERROR, errorEvent);
    };

    errorEvent = () => {
      mediaCompositionReport();
      drmReport();
      tokenReport();

      performanceReport.setPlayerResult({
        url: player.currentSource().src,
        httpStatusText: player.error().type || player.error().message,
        duration: false,
      });

      // Avoid sending error report twice
      if (!isErrorReportSent) {
        performanceService.send(performanceReport);
        isErrorReportSent = true;
      }

      player.off(PlayerEvents.CAN_PLAY_THROUGH, canplaythroughEvent);
    };

    player.one(PlayerEvents.CAN_PLAY_THROUGH, canplaythroughEvent);
    player.one(PlayerEvents.ERROR, errorEvent);

    return performanceReport;
  }

  /**
   * Remove unnecessary resources has RTMP and HDS.
   * @param {Array} resources
   */
  function filterFlashSources(resources = []) {
    return resources.filter(resource => !['RTMP', 'HDS'].includes(resource.streaming));
  }

  /**
   * Get the ResourceList from the DataProvider.
   * Pass the diagnostic object to the performance report.
   *
   * - Remove old resources such as RTMP and HDS
   * - Remove DASH resources if Safari browser
   * - Set the token if the resource if protected by a token
   *
   * @param {Array} sourceList
   * @param {PerformanceReport} performanceReport
   * @return {Object} Video.js resource list
   */
  function getResourceList(sourceList, performanceReport) {
    try {
      let resources = filterFlashSources(sourceList);

      if (!videojs.browser.IS_ANY_SAFARI &amp;&amp; Drm.hasDrm(resources)) {
        resources = resources.filter(r => r.streaming === 'DASH');
      }

      if (videojs.browser.IS_ANY_SAFARI &amp;&amp; Drm.hasDrm(resources)) {
        resources = resources.filter(r => r.streaming === 'HLS');
      }

      const { hdMode } = player.options().SRGProviders.letterbox;

      if (hdMode === false) {
        const sdResources = resources
          .filter(r => ![SRGQuality.types.HD, SRGQuality.types.HQ].includes(r.quality));

        if (sdResources.length > 0) {
          resources = sdResources;
        }
      }

      if (SRGTokenType.isProtected(resources)) {
        return AkamaiTokenService
          .tokenizeSources(resources)
          .then(r => r)
          .catch((reason) => {
            performanceReport.setTokenResult(reason);
            player.error(ERRORTYPE.ERROR_BLOCKING_REASON_UNKNOWN);

            return undefined;
          });
      }

      return resources;
    } catch (e) {
      performanceReport.setTokenResult(e);
      player.error(ERRORTYPE.ERROR_BLOCKING_REASON_UNKNOWN);

      return undefined;
    }
  }

  /**
   * Activate or not the live tracking depending on the stream type.
   * @param {String} streamType
   */
  function liveTracking(streamType) {
    if (SRGStreamType.isDvr(streamType)) {
      player.options({ liveui: true });
      player.liveTracker.startTracking();
    } else {
      player.options({ liveui: false });
      player.liveTracker.stopTracking();
    }
  }

  function getMediaComposition(urn, standalone, performanceReport) {
    return player.options().SRGProviders
      .dataService
      .getMediaCompositionByUrn(
        urn,
        standalone,
      ).then(
        ({ diagnostic, mediaComposition }) => {
          performanceReport.setIlResult(diagnostic);
          return mediaComposition;
        },
      ).catch(
        (e) => {
          performanceReport.setIlResult(e);
          player.error(ERRORTYPE.IL_ERROR);
          return undefined;
        },
      );
  }

  function triggerAspectRatio({ aspectRatio }) {
    if (aspectRatio) {
      player.trigger({
        type: SRGEvents.ASPECT_RATIO,
        data: { aspectRatio },
      });
    }
  }

  async function setSource(srcObj) {
    clearError();

    if (player.options().SRGProviders.periodicListener) {
      player.options().SRGProviders.periodicListener.stop();
    }

    const {
      src: urn, playbackSettings, pendingSeek, standalone,
    } = srcObj;

    let mediaComposition;
    const performanceReport = createPerformanceReport(urn);

    if (srcObj.mediaComposition) {
      // eslint-disable-next-line prefer-destructuring
      mediaComposition = srcObj.mediaComposition;
    } else {
      mediaComposition = await getMediaComposition(urn, standalone, performanceReport);
    }

    if (mediaComposition) {
      log.debug('Media composition loaded');

      player.options({
        SRGProviders: {
          mediaComposition: Object.assign(
            new MediaComposition(),
            mediaComposition,
            {
              pendingSeek,
              playbackSettings,
            },
          ),
        },
      });

      player.trigger({
        type: SRGEvents.MEDIACOMPOSITION_LOADED,
        data: { mediaComposition: player.options().SRGProviders.mediaComposition },
      });

      triggerAspectRatio(player.options().SRGProviders.mediaComposition.getMainChapter());
    } else {
      log.warn('No media composition');
      // If the mediaComposition is undefined that means an exception was thrown.
      // Stop player's lifecycle
      return;
    }

    const resourcesList = await getResourceList(player.options().SRGProviders
      .mediaComposition
      .getMainResources(), performanceReport);

    player.options({
      SRGProviders: {
        periodicListener: new MediaCompositionPeriodicListener(
          player.options().SRGProviders.mediaComposition.chapterUrn,
          standalone,
          player,
        ),
      },
    });
    player.options().SRGProviders.periodicListener.start();

    // If the resourcesList is undefined that means an exception was thrown.
    // Stop player's lifecycle
    if (!resourcesList) {
      log.warn('No resource');
      return;
    }

    if (player.options().SRGProviders.mediaComposition.getMainBlockReason()) {
      player.error(
        BlockingReason.toError(player.options().SRGProviders.mediaComposition.getMainBlockReason()),
      );
      return;
    }

    addExternalSubtitles();

    player.poster(player.options().SRGProviders.mediaComposition.getMainChapterImageUrl());

    if (!SupportedDevices.isDRMSupported() &amp;&amp; Drm.hasDrm(resourcesList)) {
      player.error(
        ERRORTYPE.ERROR_DRM_NOT_SUPPORTED_MESSAGE,
      );

      return;
    }

    player.src(resourcesList);

    if (player.currentSource().mediaType !== 'AUDIO') {
      player.removeClass('srgssr-audio-source');
      // TODO remove this line when videojs is updated to >= 7.8.4, see Letterbox.js #1030
      player.$('video').setAttribute('crossorigin', 'anonymous');
    } else {
      player.addClass('srgssr-audio-source');
    }

    if (videojs.browser.IS_ANY_SAFARI &amp;&amp; Drm.hasDrm(resourcesList)) {
      // TODO - WARNING - workaround for safari DRM, re-initialize the EME plugin.
      // eslint-disable-next-line no-param-reassign
      player.eme = videojs.getPlugin('eme');
      player.eme();
    }

    liveTracking(player.currentSource().streamType);

    log.debug('Srgssr middleware ready');
  }

  return {
    setSource,
  };
};

export default SrgssrMiddleware;
videojs.use('srgssr/urn', player => SrgssrMiddleware(player));
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="SRGLetterbox.html">SRGLetterbox</a></li><li><a href="SRGLetterbox.MediaComposition.html">MediaComposition</a></li><li><a href="SRGUserStorage.html">SRGUserStorage</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:ADD_TRACK">ADD_TRACK</a></li><li><a href="global.html#event:ANIMATION_END">ANIMATION_END</a></li><li><a href="global.html#event:BEFOREUNLOAD">BEFOREUNLOAD</a></li><li><a href="global.html#event:CHANGE">CHANGE</a></li><li><a href="global.html#event:CLICK">CLICK</a></li><li><a href="global.html#event:KEY_DOWN">KEY_DOWN</a></li><li><a href="global.html#event:MOUSE_ENTER">MOUSE_ENTER</a></li><li><a href="global.html#event:srgssr/recommendationDisplayed">srgssr/recommendationDisplayed</a></li><li><a href="global.html#event:srgssr/recommendationHit">srgssr/recommendationHit</a></li><li><a href="global.html#event:WEBKIT_CURRENT_PLAYBACK_TARGET_IS_WIRELESS_CHANGED">WEBKIT_CURRENT_PLAYBACK_TARGET_IS_WIRELESS_CHANGED</a></li><li><a href="global.html#event:WEBKIT_PLAYBACK_TARGET_AVAILABILITY_CHANGED">WEBKIT_PLAYBACK_TARGET_AVAILABILITY_CHANGED</a></li><li><a href="SRGLetterbox.html#event:events">events</a></li><li><a href="SRGLetterbox.html#event:playerEvents">playerEvents</a></li><li><a href="SRGLetterbox.html#event:srgEvents">srgEvents</a></li><li><a href="SRGLetterbox.html#event:videojsEvents">videojsEvents</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ABORT">ABORT</a></li><li><a href="global.html#ALMOST_STARTING">ALMOST_STARTING</a></li><li><a href="global.html#containQualities">containQualities</a></li><li><a href="global.html#DISPOSE">DISPOSE</a></li><li><a href="global.html#filterMainResourcesByQuality">filterMainResourcesByQuality</a></li><li><a href="global.html#findChapterByUrn">findChapterByUrn</a></li><li><a href="global.html#findDrmListByResource">findDrmListByResource</a></li><li><a href="global.html#findMainSegment">findMainSegment</a></li><li><a href="global.html#findResourceListByUrn">findResourceListByUrn</a></li><li><a href="global.html#getChapters">getChapters</a></li><li><a href="global.html#getFilteredExternalSubtitles">getFilteredExternalSubtitles</a></li><li><a href="global.html#getMainBlockReason">getMainBlockReason</a></li><li><a href="global.html#getMainChapter">getMainChapter</a></li><li><a href="global.html#getMainChapterImageUrl">getMainChapterImageUrl</a></li><li><a href="global.html#getMainResources">getMainResources</a></li><li><a href="global.html#getMainSegments">getMainSegments</a></li><li><a href="global.html#getMainValidFromDate">getMainValidFromDate</a></li><li><a href="global.html#getMergedAnalyticsData">getMergedAnalyticsData</a></li><li><a href="global.html#getMergedAnalyticsMetadata">getMergedAnalyticsMetadata</a></li><li><a href="global.html#getResourceList">getResourceList</a></li><li><a href="global.html#getSubdivisions">getSubdivisions</a></li><li><a href="global.html#isSourceHD">isSourceHD</a></li><li><a href="global.html#MAX_ITEMS">MAX_ITEMS</a></li><li><a href="global.html#MAX_ROWS">MAX_ROWS</a></li><li><a href="global.html#MIN_HEIGHT">MIN_HEIGHT</a></li><li><a href="global.html#MIN_WIDTH">MIN_WIDTH</a></li><li><a href="global.html#orderMainResourcesByQuality">orderMainResourcesByQuality</a></li><li><a href="global.html#orderMainResourcesByStreamType">orderMainResourcesByStreamType</a></li><li><a href="global.html#PERCENTAGE_MEDIA_CONSUMED">PERCENTAGE_MEDIA_CONSUMED</a></li><li><a href="global.html#PERIOD">PERIOD</a></li><li><a href="global.html#prefix">prefix</a></li><li><a href="global.html#SOON_VALID_PERIOD">SOON_VALID_PERIOD</a></li><li><a href="global.html#TOLERANCE">TOLERANCE</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Fri Feb 12 2021 09:53:42 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
