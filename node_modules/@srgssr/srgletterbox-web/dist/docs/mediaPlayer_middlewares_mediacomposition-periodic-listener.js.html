<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: mediaPlayer/middlewares/mediacomposition-periodic-listener.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: mediaPlayer/middlewares/mediacomposition-periodic-listener.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import BlockingReason from '../../utils/BlockingReason.js';
import * as Events from '../../utils/Events.js';

/** Update period used while playing or waiting for content to be valid. */
const PERIOD = 15000;
/** Update period used when content is supposed to be valid. */
const SOON_VALID_PERIOD = 3000;

/**
 * Periodic Listener monitoring changes in media composition.
 * @ignore
 */
export default class MediaCompositionPeriodicListener {
  constructor(urn, standalone, player) {
    this.chapterUrn = urn;
    this.standalone = standalone;
    this.player = player;
    this.log = player.log;
    player.on([Events.ENDED, Events.DISPOSE], this.stop.bind(this));
  }

  start() {
    this.scheduleCall();
  }

  stop() {
    this.chapterUrn = null;
    window.clearTimeout(this.timeoutId);
  }

  periodicCall() {
    const options = this.player.options();
    const { SRGProviders } = options;

    if (SRGProviders.mediaComposition.chapterUrn !== this.chapterUrn) {
      this.stop();
      return;
    }

    SRGProviders
      .dataService
      .getMediaCompositionByUrn(
        this.chapterUrn,
        this.standalone,
      )
      .then((result) => {
        this.log.debug('Handle new mediacomposition');
        this.handleMediaComposition(result.mediaComposition);
      })
      .catch(() => {
        // We ignore network and server errors
        this.scheduleCall();
      });
  }

  scheduleCall() {
    const { mediaComposition } = this.player.options().SRGProviders;

    const timeUntilValid = mediaComposition.getMainValidFromDate() - new Date();
    let period;
    if (mediaComposition.getMainBlockReason() === BlockingReason.STARTDATE &amp;&amp; timeUntilValid &lt; 0) {
      period = SOON_VALID_PERIOD;
    } else if (timeUntilValid > 0 &amp;&amp; timeUntilValid &lt; PERIOD) {
      period = timeUntilValid;
    } else {
      period = PERIOD;
    }
    this.timeoutId = window.setTimeout(this.periodicCall.bind(this), period);
  }

  handleMediaComposition(newMC) {
    const oldMC = this.player.options().SRGProviders.mediaComposition;
    this.player.options().SRGProviders.mediaComposition = newMC;

    this.player.trigger({
      type: Events.MEDIACOMPOSITION_LOADED,
      data: { mediaComposition: newMC },
    });

    const oldBlockReason = oldMC.getMainBlockReason();
    const newBlockReason = newMC.getMainBlockReason();
    if (!oldBlockReason &amp;&amp; newBlockReason) {
      this.log.warn('Stop because of a new block reason');
      this.errorAndStopPlayback(BlockingReason.toError(newBlockReason));
      return;
    }

    if (oldBlockReason !== newBlockReason) {
      this.log.warn('Reload because of block reason change');
      this.reload(newMC);
      return;
    }

    if (MediaCompositionPeriodicListener.streamUrls(newMC)
      !== MediaCompositionPeriodicListener.streamUrls(oldMC)) {
      this.log.warn('Reload because change in stream');
      this.reload(newMC);
      return;
    }

    this.scheduleCall();
  }

  reload(newMC) {
    const { letterbox } = this.player.options().SRGProviders;

    letterbox.prepareToPlayMediaComposition(
      newMC,
      undefined,
      letterbox.getPlaybackSettings(),
      true,
    );
  }

  static streamUrls(mediaComposition) {
    return JSON.stringify(mediaComposition.getMainResources().map(r => r.src).sort());
  }

  errorAndStopPlayback(error) {
    const { letterbox } = this.player.options().SRGProviders;

    this.player.reset();
    this.player.error(error);
    this.stop();

    letterbox.prepareToPlayURN(letterbox.getUrn());
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="SRGLetterbox.html">SRGLetterbox</a></li><li><a href="SRGLetterbox.MediaComposition.html">MediaComposition</a></li><li><a href="SRGUserStorage.html">SRGUserStorage</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:ADD_TRACK">ADD_TRACK</a></li><li><a href="global.html#event:ANIMATION_END">ANIMATION_END</a></li><li><a href="global.html#event:BEFOREUNLOAD">BEFOREUNLOAD</a></li><li><a href="global.html#event:CHANGE">CHANGE</a></li><li><a href="global.html#event:CLICK">CLICK</a></li><li><a href="global.html#event:KEY_DOWN">KEY_DOWN</a></li><li><a href="global.html#event:MOUSE_ENTER">MOUSE_ENTER</a></li><li><a href="global.html#event:srgssr/recommendationDisplayed">srgssr/recommendationDisplayed</a></li><li><a href="global.html#event:srgssr/recommendationHit">srgssr/recommendationHit</a></li><li><a href="global.html#event:WEBKIT_CURRENT_PLAYBACK_TARGET_IS_WIRELESS_CHANGED">WEBKIT_CURRENT_PLAYBACK_TARGET_IS_WIRELESS_CHANGED</a></li><li><a href="global.html#event:WEBKIT_PLAYBACK_TARGET_AVAILABILITY_CHANGED">WEBKIT_PLAYBACK_TARGET_AVAILABILITY_CHANGED</a></li><li><a href="SRGLetterbox.html#event:events">events</a></li><li><a href="SRGLetterbox.html#event:playerEvents">playerEvents</a></li><li><a href="SRGLetterbox.html#event:srgEvents">srgEvents</a></li><li><a href="SRGLetterbox.html#event:videojsEvents">videojsEvents</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ABORT">ABORT</a></li><li><a href="global.html#ALMOST_STARTING">ALMOST_STARTING</a></li><li><a href="global.html#containQualities">containQualities</a></li><li><a href="global.html#DISPOSE">DISPOSE</a></li><li><a href="global.html#filterMainResourcesByQuality">filterMainResourcesByQuality</a></li><li><a href="global.html#findChapterByUrn">findChapterByUrn</a></li><li><a href="global.html#findDrmListByResource">findDrmListByResource</a></li><li><a href="global.html#findMainSegment">findMainSegment</a></li><li><a href="global.html#findResourceListByUrn">findResourceListByUrn</a></li><li><a href="global.html#getChapters">getChapters</a></li><li><a href="global.html#getFilteredExternalSubtitles">getFilteredExternalSubtitles</a></li><li><a href="global.html#getMainBlockReason">getMainBlockReason</a></li><li><a href="global.html#getMainChapter">getMainChapter</a></li><li><a href="global.html#getMainChapterImageUrl">getMainChapterImageUrl</a></li><li><a href="global.html#getMainResources">getMainResources</a></li><li><a href="global.html#getMainSegments">getMainSegments</a></li><li><a href="global.html#getMainValidFromDate">getMainValidFromDate</a></li><li><a href="global.html#getMergedAnalyticsData">getMergedAnalyticsData</a></li><li><a href="global.html#getMergedAnalyticsMetadata">getMergedAnalyticsMetadata</a></li><li><a href="global.html#getResourceList">getResourceList</a></li><li><a href="global.html#getSubdivisions">getSubdivisions</a></li><li><a href="global.html#isSourceHD">isSourceHD</a></li><li><a href="global.html#MAX_ITEMS">MAX_ITEMS</a></li><li><a href="global.html#MAX_ROWS">MAX_ROWS</a></li><li><a href="global.html#MIN_HEIGHT">MIN_HEIGHT</a></li><li><a href="global.html#MIN_WIDTH">MIN_WIDTH</a></li><li><a href="global.html#orderMainResourcesByQuality">orderMainResourcesByQuality</a></li><li><a href="global.html#orderMainResourcesByStreamType">orderMainResourcesByStreamType</a></li><li><a href="global.html#PERCENTAGE_MEDIA_CONSUMED">PERCENTAGE_MEDIA_CONSUMED</a></li><li><a href="global.html#PERIOD">PERIOD</a></li><li><a href="global.html#prefix">prefix</a></li><li><a href="global.html#SOON_VALID_PERIOD">SOON_VALID_PERIOD</a></li><li><a href="global.html#TOLERANCE">TOLERANCE</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Fri Feb 12 2021 09:53:42 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
